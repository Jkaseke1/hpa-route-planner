<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>HPA Facilities Map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(90deg, #0f3460 0%, #1a1a2e 100%) !important;
            padding: 12px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .navbar-brand {
            font-size: 1.4rem;
            font-weight: 600;
            color: #fff !important;
        }

        .top-panel {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 15px 20px;
            margin: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 10px 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #333;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            padding: 10px 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #0f3460;
            box-shadow: 0 0 0 3px rgba(15, 52, 96, 0.1);
        }

        .btn {
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            border: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(15, 52, 96, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            border: none;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
        }

        .btn-outline-primary {
            border: 2px solid #0f3460;
            color: #0f3460;
        }

        .btn-outline-primary:hover {
            background: #0f3460;
            color: #fff;
        }

        .form-check {
            background: #f8f9fa;
            padding: 8px 15px 8px 35px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .form-check:hover {
            background: #e9ecef;
        }

        .form-check-input:checked {
            background-color: #0f3460;
            border-color: #0f3460;
        }

        .stats-badge {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .leaflet-popup-content {
            margin: 15px;
        }

        .popup-title {
            font-size: 16px;
            font-weight: 600;
            color: #0f3460;
            margin-bottom: 8px;
        }

        .popup-city {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .popup-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            margin: 8px 0;
        }

        .type-Hospital { background: #ffebee; color: #c62828; }
        .type-Clinic { background: #e3f2fd; color: #1565c0; }
        .type-Pharmacy { background: #e8f5e9; color: #2e7d32; }
        .type-Dental { background: #f3e5f5; color: #7b1fa2; }
        .type-Eye { background: #fff3e0; color: #ef6c00; }
        .type-Unknown { background: #f5f5f5; color: #616161; }

        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .legend-item {
                font-size: 12px;
            }
            .navbar-brand {
                font-size: 1.2rem;
            }
            .top-panel {
                margin: 10px;
                padding: 10px;
            }
            .results-container {
                width: 200px;
            }
        }

        .main-content {
            position: relative;
            margin: 0 15px 15px 15px;
            height: calc(100vh - 200px);
        }

        .map-container {
            width: 100%;
            height: 100%;
        }

        .map-container #map {
            margin: 0;
            height: 100%;
            width: 100%;
            border-radius: 15px;
        }

        .results-container {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 300px;
            max-height: calc(100% - 20px);
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
        }

        .results-header {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            color: white;
            padding: 15px;
            font-weight: 600;
        }

        .results-body {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .result-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid #0f3460;
        }

        .result-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .result-name {
            font-weight: 600;
            color: #0f3460;
            margin-bottom: 5px;
        }

        .result-city {
            color: #666;
            font-size: 12px;
        }

        .result-type {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            margin-top: 5px;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand">üó∫Ô∏è HPA Facilities Map</span>
            <a href="/" class="btn btn-outline-light btn-sm">Dashboard</a>
        </div>
    </nav>

    <div class="top-panel">
        <div class="d-flex gap-2 flex-wrap mb-2">
            <select id="cityFilter" class="form-select form-select-sm" style="max-width:200px">
                <option value="">All Cities</option>
            </select>

            <input id="searchInput" class="form-control form-control-sm"
                   placeholder="Search facility name..." style="max-width:250px">

            <button class="btn btn-sm btn-primary" onclick="applyFilters()">üîç Search</button>

            <button class="btn btn-sm btn-outline-primary" onclick="exportCSV()">‚¨á Export CSV</button>
        </div>

        <div class="legend">
            <div class="legend-item"><span class="legend-dot" style="background:#e53935;"></span> Hospital</div>
            <div class="legend-item"><span class="legend-dot" style="background:#1e88e5;"></span> Clinic</div>
            <div class="legend-item"><span class="legend-dot" style="background:#43a047;"></span> Pharmacy</div>
            <div class="legend-item"><span class="legend-dot" style="background:#8e24aa;"></span> Dental</div>
            <div class="legend-item"><span class="legend-dot" style="background:#fb8c00;"></span> Eye Clinic</div>
            <div class="legend-item"><span class="legend-dot" style="background:#757575;"></span> Unknown</div>
            <span class="stats-badge ms-auto" id="facilityCount">0 facilities</span>
        </div>

        <div class="d-flex gap-3 mt-2 flex-wrap">
            <div class="form-check">
                <input class="form-check-input type-filter" type="checkbox" id="showHospital" checked onchange="applyFilters()">
                <label class="form-check-label" for="showHospital">Hospital</label>
            </div>
            <div class="form-check">
                <input class="form-check-input type-filter" type="checkbox" id="showClinic" checked onchange="applyFilters()">
                <label class="form-check-label" for="showClinic">Clinic</label>
            </div>
            <div class="form-check">
                <input class="form-check-input type-filter" type="checkbox" id="showPharmacy" checked onchange="applyFilters()">
                <label class="form-check-label" for="showPharmacy">Pharmacy</label>
            </div>
            <div class="form-check">
                <input class="form-check-input type-filter" type="checkbox" id="showDental" checked onchange="applyFilters()">
                <label class="form-check-label" for="showDental">Dental</label>
            </div>
            <div class="form-check">
                <input class="form-check-input type-filter" type="checkbox" id="showEye" checked onchange="applyFilters()">
                <label class="form-check-label" for="showEye">Eye Clinic</label>
            </div>
            <div class="form-check">
                <input class="form-check-input type-filter" type="checkbox" id="showUnknown" checked onchange="applyFilters()">
                <label class="form-check-label" for="showUnknown">Unknown</label>
            </div>
            <a href="/route-planner" class="btn btn-sm btn-success ms-auto">üöó Route Planner</a>
        </div>
    </div>

    <div class="main-content">
        <div class="map-container">
            <div id="map"></div>
        </div>
        <div class="results-container">
            <div class="results-header">
                <i class="fas fa-list"></i> Search Results
                <span class="badge bg-light text-dark ms-2" id="resultCount">0</span>
            </div>
            <div class="results-body" id="resultsBody">
                <div class="text-center text-muted p-4">
                    <i class="fas fa-search fa-2x mb-2"></i><br>
                    Search to see results
                </div>
            </div>
        </div>
    </div>

    <script>
        const iconColors = {
            "Hospital": "#e53935",
            "Clinic": "#1e88e5",
            "Pharmacy": "#43a047",
            "Dental": "#8e24aa",
            "Eye Clinic": "#fb8c00",
            "Unknown": "#757575"
        };

        function getTypeIcon(type) {
            const icons = {
                "Hospital": "üè•",
                "Clinic": "ü©∫",
                "Pharmacy": "üíä",
                "Dental": "ü¶∑",
                "Eye Clinic": "üëÅÔ∏è",
                "Unknown": "üìç"
            };
            return icons[type] || "üìç";
        }

        // Use Canvas renderer for better performance
        const canvasRenderer = L.canvas({ padding: 0.5 });

        const map = L.map("map", {
            maxBounds: [[-22.5, 25], [-15, 34]],
            maxBoundsViscosity: 1,
            preferCanvas: true
        }).setView([-19.0154, 29.1549], 6);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

        let allData = [];
        let markers = [];
        let lastHash = "";

        function hashData(data) {
            return JSON.stringify(data).length;
        }

        function inferFacilityType(name) {
            if (!name) return "Unknown";
            name = name.toLowerCase();

            if (name.includes("hospital")) return "Hospital";
            if (name.includes("clinic")) return "Clinic";
            if (name.includes("pharmacy")) return "Pharmacy";
            if (name.includes("dental")) return "Dental";
            if (name.includes("eye") || name.includes("optic")) return "Eye Clinic";

            return "Unknown";
        }

        function loadData() {
            fetch(`/api/map/facilities?t=${Date.now()}`)
                .then(r => r.json())
                .then(data => {
                    data.forEach(d => {
                        if (!d["Facility Type"]) {
                            d["Facility Type"] = inferFacilityType(d["Facility Name"]);
                        }
                    });

                    const newHash = hashData(data);

                    if (newHash !== lastHash) {
                        lastHash = newHash;
                        allData = data;
                        populateCities(data);
                        applyFilters();
                        console.log("üü¢ Map updated with new data");
                    }
                })
                .catch(err => console.error("Map refresh failed:", err));
        }

        function populateCities(data) {
            const sel = document.getElementById("cityFilter");
            sel.innerHTML = `<option value="">All Cities</option>`;
            const cities = [...new Set(data.map(d => d.City).filter(Boolean))].sort();
            cities.forEach(c => {
                const o = document.createElement("option");
                o.value = c;
                o.textContent = c;
                sel.appendChild(o);
            });
        }

        function render(data) {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            data.forEach(d => {
                if (!d.Latitude || !d.Longitude) return;

                const color = iconColors[d["Facility Type"]] || "#757575";
                const typeClass = d["Facility Type"].replace(" ", "");

                // Use circleMarker with Canvas renderer - much faster than divIcon
                const marker = L.circleMarker([d.Latitude, d.Longitude], {
                    renderer: canvasRenderer,
                    radius: 6,
                    fillColor: color,
                    color: "#fff",
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                });

                marker.bindPopup(`
                    <div class="popup-title">${d["Facility Name"]}</div>
                    <div class="popup-city"><i class="fas fa-map-marker-alt"></i> ${d.City || "Unknown City"}</div>
                    <span class="popup-type type-${typeClass}">${getTypeIcon(d["Facility Type"])} ${d["Facility Type"]}</span>
                    <div style="margin-top:12px;">
                        <a class="btn btn-sm btn-primary w-100"
                           href="https://www.google.com/maps?q=${d.Latitude},${d.Longitude}"
                           target="_blank">
                           <i class="fas fa-external-link-alt"></i> View on Google Maps
                        </a>
                    </div>
                `);

                marker.addTo(map);
                markers.push(marker);
            });
        }

        function getSelectedTypes() {
            const types = [];
            if (document.getElementById("showHospital").checked) types.push("Hospital");
            if (document.getElementById("showClinic").checked) types.push("Clinic");
            if (document.getElementById("showPharmacy").checked) types.push("Pharmacy");
            if (document.getElementById("showDental").checked) types.push("Dental");
            if (document.getElementById("showEye").checked) types.push("Eye Clinic");
            if (document.getElementById("showUnknown").checked) types.push("Unknown");
            return types;
        }

        function applyFilters() {
            const city = cityFilter.value.toLowerCase();
            const q = searchInput.value.toLowerCase();
            const selectedTypes = getSelectedTypes();

            const filtered = allData.filter(d =>
                (!city || d.City?.toLowerCase() === city) &&
                (!q || d["Facility Name"]?.toLowerCase().includes(q)) &&
                selectedTypes.includes(d["Facility Type"])
            );

            render(filtered);
            renderResults(filtered);
            
            // Update count display
            document.getElementById("facilityCount").textContent = `${filtered.length} facilities`;
            console.log(`Showing ${filtered.length} of ${allData.length} facilities`);
        }

        function renderResults(data) {
            const resultsBody = document.getElementById("resultsBody");
            const resultCount = document.getElementById("resultCount");
            
            resultCount.textContent = data.length;
            
            if (data.length === 0) {
                resultsBody.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-exclamation-circle fa-2x mb-2"></i><br>
                        No facilities found
                    </div>
                `;
                return;
            }
            
            let html = '';
            data.forEach((d, index) => {
                const typeClass = d["Facility Type"].replace(" ", "");
                const color = iconColors[d["Facility Type"]] || "#757575";
                html += `
                    <div class="result-item" onclick="focusFacility(${index})">
                        <div class="result-name">${getTypeIcon(d["Facility Type"])} ${d["Facility Name"]}</div>
                        <div class="result-city"><i class="fas fa-map-marker-alt"></i> ${d.City || "Unknown City"}</div>
                        <span class="result-type type-${typeClass}">${d["Facility Type"]}</span>
                    </div>
                `;
            });
            
            resultsBody.innerHTML = html;
        }

        function focusFacility(index) {
            const filtered = getFilteredData();
            const facility = filtered[index];
            if (facility && facility.Latitude && facility.Longitude) {
                map.setView([facility.Latitude, facility.Longitude], 15);
                // Find and open the marker popup
                markers.forEach(m => {
                    const latlng = m.getLatLng();
                    if (Math.abs(latlng.lat - facility.Latitude) < 0.0001 && 
                        Math.abs(latlng.lng - facility.Longitude) < 0.0001) {
                        m.openPopup();
                    }
                });
            }
        }

        function getFilteredData() {
            const city = cityFilter.value.toLowerCase();
            const q = searchInput.value.toLowerCase();
            const selectedTypes = getSelectedTypes();

            return allData.filter(d =>
                (!city || d.City?.toLowerCase() === city) &&
                (!q || d["Facility Name"]?.toLowerCase().includes(q)) &&
                selectedTypes.includes(d["Facility Type"])
            );
        }

        cityFilter.onchange = applyFilters;

        function exportCSV() {
            let csv = "Facility Name,City,Facility Type,Latitude,Longitude\n";
            allData.forEach(d => {
                csv += `"${d["Facility Name"]}","${d.City}","${d["Facility Type"]}",${d.Latitude},${d.Longitude}\n`;
            });

            const blob = new Blob([csv], { type: "text/csv" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "hpa_facilities.csv";
            a.click();
        }

        // Auto-refresh on page load
        async function autoRefresh() {
            try {
                await fetch("/api/auto-refresh", { method: "POST" });
                console.log("Data auto-refreshed on login");
            } catch (err) {
                console.error("Auto-refresh failed:", err);
            }
        }

        // Initial load with auto-refresh
        autoRefresh().then(() => loadData());

        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);
    </script>

</body>
</html>