<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>HPA Facilities Intelligence Dashboard</title>

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #eef2f7;
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }

        .kpi {
            font-size: 28px;
            font-weight: bold;
            color: #1f3c88;
        }

        .label {
            color: #64748b;
            font-size: 13px;
        }

        .btn-map {
            background-color: #0b4da2;
            border: none;
            color: white;
        }

            .btn-map:hover {
                background-color: #083b7a;
            }

        .chart-card {
            background: #fff3e0;
        }

        @media (max-width: 768px) {
            .kpi {
                font-size: 24px;
            }
            .label {
                font-size: 12px;
            }
            .navbar-brand {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>

    <nav class="navbar fixed-top navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand">üè• HPA Facilities Intelligence</span>
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-primary btn-sm" onclick="loadDashboard(true)">üîÑ Refresh</button>
                <a href="/map" class="btn btn-map btn-sm">üó∫Ô∏è View Map</a>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top:90px;">

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card p-3 text-center" style="background:#d1e7dd;">
                    <div class="kpi" id="totalFacilities">‚Äì</div>
                    <div class="label">Total Facilities</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 text-center" style="background:#f8d7da;">
                    <div class="kpi" id="geoRate">‚Äì</div>
                    <div class="label">Geocoding Success Rate</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 text-center" style="background:#cff4fc;">
                    <div class="kpi" id="cityCount">‚Äì</div>
                    <div class="label">Cities Covered</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3 text-center" style="background:#fff3cd;">
                    <div class="kpi" id="lastUpdated">‚Äì</div>
                    <div class="label">Last Updated</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card p-3 chart-card">
                    <h6>Geocoding Status</h6>
                    <canvas id="geoChart"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 chart-card">
                    <h6>Facilities by Type</h6>
                    <canvas id="typeChart"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 chart-card">
                    <h6>Top Cities (Facilities)</h6>
                    <canvas id="cityChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card p-3">
                    <h6>Quick Links</h6>
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="/map" class="btn btn-primary">üó∫Ô∏è View Full Map</a>
                        <a href="/route-planner" class="btn btn-success">üöó Route Planner</a>
                        <button class="btn btn-outline-secondary" onclick="loadDashboard(true)">üîÑ Refresh Data</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let geoChart = null, cityChart = null, typeChart = null;

        const typeColors = {
            "Hospital": "#f44336",
            "Clinic": "#2196f3",
            "Pharmacy": "#4caf50",
            "Dental": "#9c27b0",
            "Eye Clinic": "#ff9800",
            "Unknown": "#9e9e9e"
        };

        async function loadDashboard(force = false) {
            try {
                const res = await fetch("/api/summary?t=" + Date.now(), { cache: "no-store" });
                if (!res.ok) throw new Error("API failed");
                const data = await res.json();

                document.getElementById("totalFacilities").textContent = data.total;
                document.getElementById("geoRate").textContent = data.geocode_rate + "%";
                document.getElementById("cityCount").textContent = data.cities;
                document.getElementById("lastUpdated").textContent = data.last_updated;

                if (geoChart) geoChart.destroy();
                geoChart = new Chart(document.getElementById("geoChart"), {
                    type: "pie",
                    data: {
                        labels: ["Geocoded", "Missing"],
                        datasets: [{ data: [data.geocoded, data.missing], backgroundColor: ["#1f3c88", "#d9534f"] }]
                    },
                    options: {
                        responsive: true
                    }
                });

                if (cityChart) cityChart.destroy();
                cityChart = new Chart(document.getElementById("cityChart"), {
                    type: "bar",
                    data: {
                        labels: data.top_cities.map(c => c.city),
                        datasets: [{ label: "Facilities", data: data.top_cities.map(c => c.count), backgroundColor: "#0b4da2" }]
                    },
                    options: {
                        responsive: true
                    }
                });

                // Load facility types
                loadFacilityTypes();

            } catch (err) {
                console.error(err);
                alert("Failed to load dashboard data");
            }
        }

        async function loadFacilityTypes() {
            try {
                const res = await fetch("/api/facility-types?t=" + Date.now(), { cache: "no-store" });
                const data = await res.json();

                if (typeChart) typeChart.destroy();
                
                const labels = data.types || [];
                const counts = labels.map(t => data.counts[t] || 0);
                const colors = labels.map(t => typeColors[t] || "#9e9e9e");

                typeChart = new Chart(document.getElementById("typeChart"), {
                    type: "doughnut",
                    data: {
                        labels: labels,
                        datasets: [{
                            data: counts,
                            backgroundColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { boxWidth: 12, font: { size: 10 } }
                            }
                        }
                    }
                });
            } catch (err) {
                console.error("Failed to load facility types:", err);
            }
        }

        // Auto-refresh on page load
        async function autoRefresh() {
            try {
                await fetch("/api/auto-refresh", { method: "POST" });
                console.log("Data auto-refreshed on login");
            } catch (err) {
                console.error("Auto-refresh failed:", err);
            }
        }

        setInterval(loadDashboard, 60000);
        autoRefresh().then(() => loadDashboard());
    </script>

</body>
</html>